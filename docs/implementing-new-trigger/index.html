<!DOCTYPE html>
<html>
<!-- Head information -->
<head>
<meta charset='utf-8'>
<meta content='width=device-width' initial-scale='1' name='viewport'>
<!-- Always force latest IE rendering engine or request Chrome Frame -->
<!-- %meta{content: 'IE=edge,chrome=1', http-equiv: 'X-UA-Compatible'} -->
<link href='/assets/images/favicon/favicon-196x196.png' rel='icon' sizes='196x196' type='image/png'>
<link href='/assets/images/favicon/favicon-32x32.png' rel='icon' sizes='32x32' type='image/png'>
<link href='/assets/images/favicon/favicon-16x16.png' rel='icon' sizes='16x16' type='image/png'>
<link href='/assets/images/favicon/favicon-128.png' rel='icon' sizes='128x128' type='image/png'>
<link href='/assets/images/favicon/favicon.ico' rel='icon'>
<!-- Use title if it's in the page YAML frontmatter -->
<title>
Kubeless
</title>
<link href='//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css' media='screen' rel='stylesheet'>
<!-- Bitnami Design System -->
<link href='https://fonts.googleapis.com/css?family=Fira+Sans:300,400,700|Hind:300,400' media='screen' rel='stylesheet'>
<link href='//d1d5nb8vlsbujg.cloudfront.net/bitnami-ui/2.0.1/bitnami.ui.components.min.css' media='screen' rel='stylesheet'>
<link href='//d1d5nb8vlsbujg.cloudfront.net/bitnami-ui/2.0.1/bitnami.ui.min.css' media='screen' rel='stylesheet'>
<!-- Include the javascripts and the styles of the page -->
<link href="/assets/stylesheets/main.css" rel="stylesheet" />
<script src="/assets/javascripts/main.js"></script>
</head>

<!-- Main content -->
<body>
<div class='gradient-135-accent elevation-1'>
<div class='container'>
<header class='Header padding-v-big'>
<div class='row collapse-b-tablet align-center'>
<div class='col-4'>
<div class='Header__Logo'>
<a href="/"><img src="/assets/images/logo-white.svg" alt="Logo white" />
<span>
A Bitnami project
</span>
</a></div>
</div>
<div class='col-8'>
<nav class='text-r'>
<a href="/" class="margin-h-normal">Home</a>
<a href="/docs" class="margin-h-normal">Documentation</a>
<a href="https://github.com/kubeless/kubeless-ui" class="margin-h-normal">Kubeless UI</a>
<a href="https://serverless.com/framework/docs/providers/kubeless/guide/intro/" class="margin-h-normal">Serverless Plugin</a>
<a href="https://github.com/kubeless" class="margin-l-normal">GitHub</a>
</nav>
</div>
</div>
</header>

</div>
</div>
<main class='container margin-t-big'>
<div class='row collapse-b-phone-land'>
<div class='col-3'>
<h4 class='margin-t-bigger'>
<img src="/assets/images/logo-dark.svg" alt="Kubeless logo" class="float-l avatar avatar-medium" />
<div class='padding-v-small'>
Documentation
</div>
</h4>
<ul class='remove-style padding-small'>
<li>
<b>Usage</b>
</li>
<li class='margin-v-small'>
<a href="/docs/quick-start">Quick Start
</a></li>
<li class='margin-v-small'>
<a href="/docs/runtimes">Runtimes
</a></li>
<li class='margin-v-small'>
<a href="/docs/kubeless-functions">Function Characteristics
</a></li>
<li class='margin-v-small'>
<a href="/docs/triggers">Triggers
</a></li>
<li class='margin-v-small'>
<a href="/docs/pubsub-functions">PubSub Mechanism
</a></li>
<li class='margin-v-small'>
<a href="/docs/http-triggers">Expose and Secure Functions
</a></li>
<li class='margin-v-small'>
<a href="/docs/cronjob-triggers">Scheduling a function execution (CronJob)
</a></li>
<li class='margin-v-small'>
<a href="/docs/streaming-functions">Data Stream Events
</a></li>
<li class='margin-v-small'>
<a href="/docs/debug-functions">Debug Functions
</a></li>
<li class='margin-v-small'>
<a href="/docs/autoscaling">Autoscaling
</a></li>
<li class='margin-v-small'>
<a href="/docs/building-functions">Build Function Images
</a></li>
<li class='margin-v-small'>
<a href="/docs/monitoring">Monitoring
</a></li>
<li class='margin-v-small'>
<a href="/docs/advanced-function-deployment">Advanced deployment
</a></li>
<li class='margin-v-small'>
<a href="/docs/function-controller-configuration">Kubeless Configuration
</a></li>
<li class='margin-v-small'>
<a href="/docs/use-existing-kafka">Use a Custom Apache Kafka
</a></li>
<li class='margin-v-small'>
<a href="/docs/troubleshooting">Install Troubleshooting
</a></li>
<li class='padding-t-big'>
<b>Cloud Providers</b>
</li>
<li class='margin-v-small'>
<a href="/docs/kubeless-on-AKS">Azure Kubernetes Service
</a></li>
<li class='margin-v-small'>
<a href="/docs/GKE-deployment">Google Kubernetes Engine
</a></li>
<li class='padding-t-big'>
<b>Development</b>
</li>
<li class='margin-v-small'>
<a href="/docs/architecture">Architecture
</a></li>
<li class='margin-v-small'>
<a href="/docs/dev-guide">Development Guide
</a></li>
<li class='margin-v-small'>
<a href="/docs/implementing-new-runtime">Implementing a New Runtime
</a></li>
<li class='margin-v-small'>
<a href="/docs/implementing-new-trigger">Implementing a New Trigger
</a></li>
<li class='margin-v-small'>
<a href="/docs/debugging">Debugging
</a></li>
<li class='margin-v-small'>
<a href="/docs/release-flow">Release Flow
</a></li>
</ul>

</div>
<div class='col-9'>
<h1 id="how-to-add-a-new-event-source-as-trigger">How to add a new event source as Trigger</h1>

<p>Kubeless <a href="/docs/architecture">architecture</a> is built on core concepts of Functions, Triggers and Runtime. A <em>Trigger</em> in Kubeless represents association between an event source and functions that need to be invoked on an event in the event source. Kubeless fully leverages the Kubernetes concepts of <a href="https://kubernetes.io/docs/concepts/api-extension/custom-resources/">custom resource definition</a>(CRD) and <a href="https://kubernetes.io/docs/concepts/api-extension/custom-resources/#custom-controllers">custom controllers</a>. Each trigger is expected to be modelled as Kubernetes CRD. A trigger specific custom resource controller is expected to be written that realizes how deployed functions are invoked when event occurs. Following sections document how one can add a new event source as <em>Trigger</em> into Kubeless.</p>

<h2 id="triggers-development-repository">Triggers development repository</h2>

<p>Each Kubeless trigger controller is being developed on its own repository. You can find more information about those controllers in their repositories. If you want to create a new trigger you will need to create a new repository for that. These are the triggers currently available that can be used as templates for new ones:</p>

<ul>
<li><a href="https://github.com/kubeless/http-trigger">HTTP Trigger</a></li>
<li><a href="https://github.com/kubeless/cronjob-trigger">CronJob Trigger</a></li>
<li><a href="https://github.com/kubeless/kafka-trigger">Kafka Trigger</a></li>
<li><a href="https://github.com/kubeless/nats-trigger">NATS Trigger</a></li>
</ul>

<h2 id="model-event-source-as-crd">Model event source as CRD</h2>

<p>First step is to create a new CRD for the event source. CRD for the new triggers will be largely similar to the existing ones. For example below is the CRD for Kafka trigger</p>

<pre><code class="yaml">apiVersion: apiextensions.k8s.io/v1beta1
kind: CustomResourceDefinition
metadata:
  name: kafkatriggers.kubeless.io
spec:
  group: kubeless.io
  names:
    kind: KafkaTrigger
    plural: kafkatriggers
    singular: kafkatrigger
  scope: Namespaced
  version: v1beta1
</code></pre>

<p>Give appropriate and intutive name to the event source.</p>

<h2 id="model-the-crd-spec">Model the CRD spec</h2>

<p>Once CRD is defined, you need to model the event source and its attributes as resource object spec. Please see <a href="https://github.com/kubernetes/community/blob/master/contributors/devel/api-conventions.md">API conventions</a> for key attributes of Kubernetes API resource object. Except fot <code>Spec</code> part rest of the needed parts to define a Trigger are pretty similar to other Triggers.</p>

<p>For e.g below is the definition of <a href="https://github.com/kubeless/kafka-trigger/blob/master/pkg/apis/kubeless/v1beta1/kafka_trigger.go">Kafka Trigger</a></p>

<pre><code class="go">type KafkaTrigger struct {
    metav1.TypeMeta   `json:&quot;,inline&quot;`
    metav1.ObjectMeta `json:&quot;metadata&quot;`
    Spec              KafkaTriggerSpec `json:&quot;spec&quot;`
}
</code></pre>

<p>You need to model the event source attributes in to Spec attribute of new trigger. Depending on the nature of event source you may want to associate single function or multiple functions with the event source. Use appropriate mechanism to represent the association. For e.g Kafka trigger uses Kubernetes label selector to associate any function with matching label with the event source.</p>

<h2 id="code-generation">Code Generation</h2>

<p>Once you have definged the new trigger, please ensure its placed in <code>pkg/apis/kubeless/v1beta1/</code> path, and update <code>register.go</code> go to include new trigger type.</p>

<p>Now you can auto-generate the clientset, lister and informers for the new API resource object as well but running <code>make update</code> or <code>./hack/update-codegen.sh</code> within the trigger repository. Auto-generated clientset, lister and informers comes handy in writing the controller in next step.</p>

<h2 id="crd-controller">CRD controller</h2>

<p>Here is the most important step, i.e. writing controller itself. As far as the skeleton of controller goes, it would be pretty similar to existing controllers like Kafka trigger controller, nats trigger controller or http trigger controller. Functionally controller does two important things</p>

<ul>
<li>watch Kuberentes API server for CRUD operations on the new trigger object and take appropriate actions.</li>
<li>when an event occurs in the event source trigger the associated functions.</li>
</ul>

<p>Please read the code and logic for the existing <a href="https://github.com/kubeless/kafka-trigger/tree/master/pkg/controller">Kafka controller</a> as a reference.</p>

<h2 id="building-controller-binary-and-docker-image">Building controller binary and docker image</h2>

<p>Ensure you controller is an independent binary that can be built from the Makefile. Please follow one of the existing controller <a href="https://github.com/kubeless/kafka-trigger/tree/master/cmd">cmd</a> as referance. Also ensure there is corresponding <code>Dockerfile</code> to build the controller image. Please see the dockerfile for other trigger controller as a <a href="https://github.com/kubeless/kafka-trigger/tree/master/docker">reference</a>.</p>

<p>Add appropriate Makefile targets so that controller binary and docker image can be built.</p>

<h2 id="manifest">Manifest</h2>

<p>Create a jsonnet file for the new trigger and ensure that generated yaml file has CRD definition, deployment for the trigger controller and necessary RBAC rules. Again most of the stuff is common with Kafka or HTTP triggers, so take existing jsonnet manifests as a referance.</p>

<h2 id="ci">CI</h2>

<p>Once the new trigger is working it&#39;s important to add tests to ensure and preserve the trigger functionality. Each trigger should contain:</p>

<ul>
<li>Unit tests covering the basic functionality.</li>
<li>End-to-end tests that ensure the compatibility with the latest image of the Kubeless core.</li>
</ul>

<p>The CI used to run the tests is TravisCI. You can check examples of how Travis is configured <a href="https://github.com/kubeless/kafka-trigger/blob/master/.circleci/config.yml">here</a>. This file should define at least 4 jobs:</p>

<ul>
<li>One for building the binaries and manifests.</li>
<li>Another one to test the functionality end-to-end in a Minikube scenario.</li>
<li>A third one to push the image used in the tests as <code>latest</code>.</li>
<li>A final one to auto generate a release in Github in case it&#39;s building a new tag.</li>
</ul>

<p>Most of the functionality for the above depends on scripts that have been already developed so you just need to change some data and names from the YAML to make it work.</p>

<p>The tests to run are defined in the folder <code>tests/</code> of each repository. These are <a href="https://github.com/sstephenson/bats"><code>bats</code></a> that loads a common library (<code>script/libtest.bash</code>) and execute some simple scenarios. Again you can take Kafka as an example for some useful scenarios to test.</p>

</div>
</div>
</main>
<div class='margin-t-giant'>
<div class='Footer'>
<div class='container padding-h-big padding-v-bigger'>
<div class='Footer__Border padding-t-big'>
<div class='row collapse-b-phone-land'>
<div class='col-6'>
<h4 class='inverse margin-reset'>
<img src="/assets/images/logo-white.svg" alt="Kubeless logo" class="Footer__Logo" />
</h4>
<p class='type-color-iron type-small margin-reset'>
Â© Kubeless 2021 | All Rights Reserved.
</p>
</div>
<div class='col-6 text-r'>
<a href="https://github.com/kubeless" class="margin-l-small"><img src="/assets/images/social/github.svg" alt="See the Github Profile of the Kubeless project" />
</a></div>
</div>
</div>
</div>
</div>

</div>
</body>
</html>
<script src='//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js'></script>
<script>
  hljs.initHighlightingOnLoad();
</script>
